##
## Copyright 2014-2016 the original author or authors.
##
## Licensed under the Apache License, Version 2.0 (the "License");
## you may not use this file except in compliance with the License.
## You may obtain a copy of the License at
##
##     http://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
## either express or implied. See the License for the specific language
## governing permissions and limitations under the License.
##
${manager.allClassCopyright}package ${request.package}.${subPackage};
#set ($importSet = $request.getClass().forName("java.util.LinkedHashSet").newInstance())
#set ($parameterFlg = false)
#if ($tableMap.behaviorMethodGeneration == 'true')
#foreach($method in $methodList)
#if (${method.requestBean.className} && ${method.requestBean.className} != '')
#set($added = $importSet.add("${method.requestBean.package}.${method.requestBean.className}"))
#set ($parameterFlg = true)
#end
#if (${method.responseBean.package} && ${method.responseBean.package} != '' && ${method.responseBean.className} && ${method.responseBean.className} != '')
#set($added = $importSet.add("${method.responseBean.package}.${method.responseBean.className}"))
#end
#end
#end
#if ($parameterFlg)

import java.util.function.Consumer;
#end

#if ($tableMap.behaviorMethodGeneration == 'true')
import org.dbflute.remoteapi.FlutyRemoteApiRule;
import org.lastaflute.di.helper.misc.ParameterizedRef;
#end
import org.lastaflute.web.servlet.request.RequestManager;

import ${request.package}.${abstractBehaviorSubPackage}.${abstractBehaviorClassName};
#foreach($import in $importSet)
import ${import};
#end

/**
 * ${class}.
 * @author FreeGen
 */
public abstract class ${class} extends ${abstractBehaviorClassName} {

    // ===================================================================================
    //                                                                         Constructor
    //                                                                         ===========
    /***
     * @param requestManager requestManager. (NotNull)
     */
    public ${class}(RequestManager requestManager) {
        super(requestManager);
    }
#if ($tableMap.behaviorMethodGeneration == 'true')
#foreach($method in $methodList)
#set ($parameterJavadocList = [])
#set ($parameterDefinition = '')
#set ($moreUrl = '')
#set ($responseBeanClassName = 'void')
#foreach($pathPropertyEntry in $method.pathProperties.entrySet())
#if (${typeMap[$pathPropertyEntry.value.format]})
#set ($parameterClass = ${typeMap[$pathPropertyEntry.value.format]})
#elseif (${typeMap[$pathPropertyEntry.value.type]})
#set ($parameterClass = ${typeMap[$pathPropertyEntry.value.type]})
#end
#if ($pathPropertyEntry.value.description)
#set ($added = $parameterJavadocList.add("${pathPropertyEntry.key} $pathPropertyEntry.value.description. (NotNull)"))
#else
#set ($added = $parameterJavadocList.add("${pathPropertyEntry.key} $pathPropertyEntry.key. (NotNull)"))
#end
#set ($parameterDefinition = "${parameterDefinition}${parameterClass} ${pathPropertyEntry.key}, ")
#set ($moreUrl = "${moreUrl}${pathPropertyEntry.key}, ")
#end
#if (${method.requestBean.className})
#set ($parameterDefinition = "${parameterDefinition}Consumer<${method.requestBean.className}> paramLamda")
#set ($added = $parameterJavadocList.add("paramLamda The callback for $method.requestBean.className. (NotNull)"))
#end
#set ($parameterDefinition = $parameterDefinition.replaceAll(', $', ''))
#set ($moreUrl = $moreUrl.replaceAll('^(.+), $', 'moreUrl($1)'))
#if ($moreUrl == '')
#set ($moreUrl = 'noMoreUrl()')
#end
#set ($responseBeanClassName = ${method.responseBean.className})
#set ($responseBeanClassName = $scriptEngine.invokeFunction('unDefinitionKey', ${responseBeanClassName}))

#if ($foreach.index == 0)
    // ===================================================================================
    //                                                                             Execute
    //                                                                             =======
#end
    /**
     * ${method.name}.<br>
     * <pre>
     * url: $method.url
     * httpMethod: $method.httpMethod.toUpperCase()
     * </pre>
#foreach($parameterJavadoc in $parameterJavadocList)
     * @param $parameterJavadoc
#end
#if ($responseBeanClassName != 'void')
     * @return return object. (NotNull)
#end
     */
    ${tableMap.behaviorMethodAccessModifier} $responseBeanClassName request${method.name}#if ($method.multipleHttpMethod)$method.httpMethod#end($!{parameterDefinition}) {
#set ($paramMap = {})
#if ($method.httpMethod == 'Get' || $method.httpMethod == 'Delete')
#set ($param = 'noQuery()')
#else
#set ($param = 'null')
#end
#if (${method.requestBean.className} && ${method.requestBean.className} != '')
        ${method.requestBean.className} param = new ${method.requestBean.className}();
        paramLamda.accept(param);
#set($put = $paramMap.put('query', 'query(param)'))
#set($put = $paramMap.put('formData', 'param'))
#set($put = $paramMap.put('body', 'param'))
#end
#if ($paramMap.containsKey("$!{method.requestBean.in}"))
#set ($param = $paramMap["$!{method.requestBean.in}"])
#end
       #if ($responseBeanClassName != 'void') return#end doRequest${method.httpMethod}(new ParameterizedRef<$responseBeanClassName.replaceAll('void', 'Void')>() {
#if ($method.requestBean.in == 'formData')
        }.getType(), "${method.url}", $moreUrl, $param, rule -> {
            rule.sendBodyBy(
                    new org.lastaflute.remoteapi.sender.body.LaFormSender(new org.dbflute.remoteapi.mapping.FlVacantRemoteMappingPolicy()));
            ruleOf${method.name}#if ($method.multipleHttpMethod)$method.httpMethod#end(rule);
        });
#else
        }.getType(), "${method.url}", $moreUrl, $param, rule -> ruleOf${method.name}#if ($method.multipleHttpMethod)$method.httpMethod#end(rule));
#end
    }

    /**
     * Rule of ${method.name}.<br>
     * <pre>
     * url: $method.url
     * httpMethod: $method.httpMethod.toUpperCase()
     * </pre>
     * @param rule rule. (NotNull)
     */
    protected void ruleOf${method.name}#if ($method.multipleHttpMethod)$method.httpMethod#end(FlutyRemoteApiRule rule) {
    }
#end
#end
}
